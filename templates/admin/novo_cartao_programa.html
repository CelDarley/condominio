{% extends "admin/base.html" %}

{% block title %}Novo Cartão Programa - SegCond Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('admin_cartoes_programa') }}">
                        <i class="fas fa-route me-1"></i>
                        Cartões Programa
                    </a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Novo Cartão Programa</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-plus me-2"></i>
                    Novo Cartão Programa
                </h1>
                <p class="text-muted">Cadastre uma nova rota de vigilância no sistema</p>
            </div>
            <a href="{{ url_for('admin_cartoes_programa') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-edit me-2"></i>
                    Informações do Cartão Programa
                </h6>
            </div>
            <div class="card-body">
                <form method="POST" class="needs-validation" novalidate>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="nome" class="form-label">
                                    <i class="fas fa-tag me-1"></i>
                                    Nome do Cartão Programa *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="nome" 
                                       name="nome" 
                                       required 
                                       placeholder="Ex: Rota Principal, Rota Noturna, Rota de Fim de Semana">
                                <div class="invalid-feedback">
                                    Por favor, informe o nome do cartão programa.
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="tipo_rota" class="form-label">
                                    <i class="fas fa-cog me-1"></i>
                                    Tipo de Rota
                                </label>
                                <select class="form-select" id="tipo_rota" name="tipo_rota">
                                    <option value="diurna">Diurna</option>
                                    <option value="noturna">Noturna</option>
                                    <option value="24h">24 Horas</option>
                                    <option value="eventos">Eventos</option>
                                    <option value="especial">Especial</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="descricao" class="form-label">
                                    <i class="fas fa-align-left me-1"></i>
                                    Descrição da Rota
                                </label>
                                <textarea class="form-control" 
                                          id="descricao" 
                                          name="descricao" 
                                          rows="3" 
                                          placeholder="Descreva o objetivo desta rota, horários de aplicação, características especiais, etc."></textarea>
                                <div class="form-text">
                                    Informações que ajudem a entender quando e como usar esta rota.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="prioridade" class="form-label">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Prioridade
                                </label>
                                <select class="form-select" id="prioridade" name="prioridade">
                                    <option value="baixa">Baixa</option>
                                    <option value="media" selected>Média</option>
                                    <option value="alta">Alta</option>
                                    <option value="critica">Crítica</option>
                                </select>
                                <div class="form-text">
                                    Define a importância desta rota para a segurança.
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="frequencia" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    Frequência de Uso
                                </label>
                                <select class="form-select" id="frequencia" name="frequencia">
                                    <option value="diaria">Diária</option>
                                    <option value="semanal">Semanal</option>
                                    <option value="quinzenal">Quinzenal</option>
                                    <option value="mensal">Mensal</option>
                                    <option value="eventos">Apenas em eventos</option>
                                    <option value="sob_demanda">Sob demanda</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horario_inicio" class="form-label">
                                    <i class="fas fa-clock me-1"></i>
                                    Horário de Início
                                </label>
                                <input type="time" 
                                       class="form-control" 
                                       id="horario_inicio" 
                                       name="horario_inicio" 
                                       value="06:00">
                                <div class="form-text">
                                    Horário em que a rota deve começar a ser executada.
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="horario_fim" class="form-label">
                                    <i class="fas fa-clock me-1"></i>
                                    Horário de Fim
                                </label>
                                <input type="time" 
                                       class="form-control" 
                                       id="horario_fim" 
                                       name="horario_fim" 
                                       value="22:00">
                                <div class="form-text">
                                    Horário em que a rota deve terminar.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="dias_semana" class="form-label">
                                    <i class="fas fa-calendar-week me-1"></i>
                                    Dias da Semana
                                </label>
                                <div class="row">
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="segunda" name="dias_semana" value="0" checked>
                                            <label class="form-check-label" for="segunda">Segunda</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="terca" name="dias_semana" value="1" checked>
                                            <label class="form-check-label" for="terca">Terça</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="quarta" name="dias_semana" value="2" checked>
                                            <label class="form-check-label" for="quarta">Quarta</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="quinta" name="dias_semana" value="3" checked>
                                            <label class="form-check-label" for="quinta">Quinta</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sexta" name="dias_semana" value="4" checked>
                                            <label class="form-check-label" for="sexta">Sexta</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="sabado" name="dias_semana" value="5">
                                            <label class="form-check-label" for="sabado">Sábado</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2 col-4 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="domingo" name="dias_semana" value="6">
                                            <label class="form-check-label" for="domingo">Domingo</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-text">
                                    Selecione os dias em que esta rota deve ser executada.
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requer_equipamento" name="requer_equipamento">
                                    <label class="form-check-label" for="requer_equipamento">
                                        <i class="fas fa-tablet-alt me-1"></i>
                                        Requer equipamento específico (rádio, tablet, etc.)
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requer_veiculo" name="requer_veiculo">
                                    <label class="form-check-label" for="requer_veiculo">
                                        <i class="fas fa-car me-1"></i>
                                        Requer veículo para execução
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="requer_dois_vigilantes" name="requer_dois_vigilantes">
                                    <label class="form-check-label" for="requer_dois_vigilantes">
                                        <i class="fas fa-users me-1"></i>
                                        Requer dois vigilantes para execução
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="ativo" name="ativo" checked>
                                    <label class="form-check-label" for="ativo">
                                        <i class="fas fa-check-circle me-1"></i>
                                        Cartão ativo (disponível para uso)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('admin_cartoes_programa') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>
                            Cancelar
                        </a>
                        
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            Salvar Cartão Programa
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Preview do Cartão Programa -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-eye me-2"></i>
                    Preview do Cartão Programa
                </h6>
            </div>
            <div class="card-body">
                <div id="previewCartaoPrograma" class="text-center text-muted">
                    <i class="fas fa-route fa-2x mb-2"></i>
                    <p>Preencha os campos acima para ver o preview</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Próximos Passos -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow border-info">
            <div class="card-header bg-info text-white">
                <h6 class="m-0 font-weight-bold">
                    <i class="fas fa-info-circle me-2"></i>
                    Próximos Passos
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-1 fa-2x text-primary mb-2"></i>
                            <h6>1. Salvar Cartão</h6>
                            <small class="text-muted">Primeiro, salve as informações básicas</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-2 fa-2x text-success mb-2"></i>
                            <h6>2. Configurar Pontos</h6>
                            <small class="text-muted">Defina os pontos base e horários</small>
                        </div>
                    </div>
                    <div class="col-md-4 text-center mb-3">
                        <div class="border rounded p-3">
                            <i class="fas fa-3 fa-2x text-warning mb-2"></i>
                            <h6>3. Criar Itinerários</h6>
                            <small class="text-muted">Estabeleça as rotas entre pontos</small>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <p class="text-muted mb-0">
                        <i class="fas fa-lightbulb me-1"></i>
                        Após salvar, você será redirecionado para a configuração completa do cartão programa.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Validação em tempo real
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.needs-validation');
    const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
    
    inputs.forEach(input => {
        input.addEventListener('blur', function() {
            if (!this.value.trim()) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
        
        input.addEventListener('input', function() {
            if (this.value.trim()) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            }
        });
    });
    
    // Preview em tempo real
    const previewFields = ['nome', 'descricao', 'tipo_rota', 'prioridade', 'frequencia'];
    previewFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('input', updatePreview);
            field.addEventListener('change', updatePreview);
        }
    });
    
    // Atualizar preview inicial
    updatePreview();
});

function updatePreview() {
    const nome = document.getElementById('nome')?.value || '';
    const descricao = document.getElementById('descricao')?.value || '';
    const tipoRota = document.getElementById('tipo_rota')?.value || '';
    const prioridade = document.getElementById('prioridade')?.value || '';
    const frequencia = document.getElementById('frequencia')?.value || '';
    
    const preview = document.getElementById('previewCartaoPrograma');
    
    if (nome) {
        let html = `
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-route me-2"></i>
                        ${nome}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Tipo:</strong> ${getTipoRotaLabel(tipoRota)}</p>
                            <p><strong>Prioridade:</strong> ${getPrioridadeLabel(prioridade)}</p>
                            <p><strong>Frequência:</strong> ${getFrequenciaLabel(frequencia)}</p>
                        </div>
                        <div class="col-md-6">
                            ${descricao ? `<p><strong>Descrição:</strong> ${descricao}</p>` : ''}
                            <p><strong>Dias Selecionados:</strong></p>
                            <div id="diasSelecionados">
                                <!-- Será atualizado dinamicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        preview.innerHTML = html;
        
        // Atualizar dias selecionados
        atualizarDiasSelecionados();
    } else {
        preview.innerHTML = `
            <i class="fas fa-route fa-2x mb-2"></i>
            <p>Preencha os campos obrigatórios para ver o preview</p>
        `;
    }
}

function atualizarDiasSelecionados() {
    const diasCheckboxes = document.querySelectorAll('input[name="dias_semana"]:checked');
    const container = document.getElementById('diasSelecionados');
    
    if (diasCheckboxes.length > 0) {
        const dias = Array.from(diasCheckboxes).map(cb => {
            const labels = ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'];
            return labels[parseInt(cb.value)];
        });
        
        container.innerHTML = dias.map(dia => `<span class="badge bg-secondary me-1">${dia}</span>`).join('');
    } else {
        container.innerHTML = '<span class="text-muted">Nenhum dia selecionado</span>';
    }
}

// Atualizar preview quando dias são alterados
document.querySelectorAll('input[name="dias_semana"]').forEach(checkbox => {
    checkbox.addEventListener('change', updatePreview);
});

function getTipoRotaLabel(tipo) {
    const tipos = {
        'diurna': 'Diurna',
        'noturna': 'Noturna',
        '24h': '24 Horas',
        'eventos': 'Eventos',
        'especial': 'Especial'
    };
    return tipos[tipo] || tipo;
}

function getPrioridadeLabel(prioridade) {
    const prioridades = {
        'baixa': '<span class="badge bg-success">Baixa</span>',
        'media': '<span class="badge bg-warning">Média</span>',
        'alta': '<span class="badge bg-danger">Alta</span>',
        'critica': '<span class="badge bg-dark">Crítica</span>'
    };
    return prioridades[prioridade] || prioridade;
}

function getFrequenciaLabel(frequencia) {
    const frequencias = {
        'diaria': 'Diária',
        'semanal': 'Semanal',
        'quinzenal': 'Quinzenal',
        'mensal': 'Mensal',
        'eventos': 'Apenas em eventos',
        'sob_demanda': 'Sob demanda'
    };
    return frequencias[frequencia] || frequencia;
}

// Validação do formulário antes do envio
document.querySelector('form').addEventListener('submit', function(e) {
    if (!this.checkValidity()) {
        e.preventDefault();
        e.stopPropagation();
        
        // Mostrar mensagem de erro
        window.segCondAdmin.showNotification('Por favor, preencha todos os campos obrigatórios.', 'error');
    }
    
    this.classList.add('was-validated');
});
</script>
{% endblock %}
